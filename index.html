<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Голосование</title>

</head>
<body>
    <style>
        #formItems{
            background-color: cadetblue;
            border-radius: 5%;
            line-height: 30px;
            width: 45%;
            text-indent: 15%;
            }
        #stat_form{
            display: inline-block;
            width: 45%;
            background-color: darkseagreen;
            text-indent: 15%;
            border-radius: 5%;
            margin-top: 5%;
        }
        #clickMe{
            margin-left: 10%;
        }
    </style>
<div name="postForm" id="formItems">
  <h3>Какое блюдо предпочитаете?</h3>
</div>
<div name="stat_form" id="stat_form">
    <h3>Текущая статистика:</h3>
</div>
</body>
<script>
let itemsDiv;
try
{
    fetch('/variants',{
        method: 'GET'
    })
    .then(function(response){ return response.json();})
    .then(function(json) {
        let itemsForm = JSON.parse(json);
        let myForm = document.getElementById('formItems');

        for(var i = 0; i< itemsForm.length; i++)
         {
        let newInput = document.createElement('input');            
        let newBr = document.createElement('br'); 
              newInput.type = 'radio';
              newInput.value = 'var'+itemsForm[i]['code'];
              newInput.id = 'var'+itemsForm[i]['code'];
              newInput.name = 'dish';
        let newLabel = document.createElement('label');  
              newLabel.for = 'var'+itemsForm[i]['code'];
              newLabel.innerText = itemsForm[i]['text'];
              myForm.appendChild(newInput);
              myForm.appendChild(newLabel);  
              myForm.appendChild(newBr);
         }  

        let newBut = document.createElement('input');    
          //   newBut.type = 'submit';
            newBut.type = 'button';
            newBut.value = 'Отправить ответ';
            newBut.id = 'clickMe';        
        myForm.appendChild(newBut);   
        document.getElementById('clickMe').addEventListener('click', addnewfetch, true);  
//stat
        let myDiv = document.getElementById('stat_form');
            let newUl = document.createElement('ul');
            newUl.id = 'UlIems'; 
            
            for(var i = 1; i<= itemsForm.length; i++)
            {
            let newBrUl = document.createElement('br'); 
            let newLi = document.createElement('li'); 
            newLi.name = 'li'+i;
                newLi.innerHTML = 'var'+i + '- ' + itemsDiv["var" + i];
                newLi.id = 'li' + i;
                newUl.appendChild(newLi);  
            }  
            myDiv.appendChild(newUl);
    }) 
    }
    catch{
        console.log('error');
    }

try
{
    fetch('/stat', {
        method: 'POST'
    })
    .then(function(response){ return response.json();})
    .then(function(json) {
        itemsDiv = json;
           return itemsDiv;
    }) 
}
catch{
        console.log('error stat');
    }


    
function addnewfetch()
{
    let newVar = document.getElementsByName('dish');
    for(var i=0; i<newVar.length; i++)
    {
        if(document.getElementsByName('dish')[i].checked)
        {
            var itemVar = document.getElementsByName('dish')[i].value;
            document.getElementsByName('dish')[i].checked = false;
            console.log(itemVar);    
        }    
    }    
    if(!itemVar)
        var itemVar = 0;
    fetch('/voit',{
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({"dish": itemVar})
    })
    .then(function(){ var ans = getStat();})
    .then(function(){ var ans = getStatIndex();});
    
}



 async function getStat(){
 
  /*  var apiCallPromise  = await fetch('/stat', {method: 'POST'});
    var itemsDiv = await apiCallPromise.json();
    console.log(itemsDiv);
    return itemsDiv;*/
await fetch('/stat', {
        method: 'POST'
    })
 
    .then(function(response){ return response.json();})
    .then(function(json) {
        itemsDiv = json;
        console.log(itemsDiv);
        return itemsDiv;    
 })

}
 function getStatIndex(){
  
var myli = document.getElementsByTagName("li");    
var j=0;    
    for(var i in itemsDiv)
{
    myli[j].innerHTML =  i + '- ' + JSON.stringify(itemsDiv[i]);
    j++;
}  

return true; 
 }





</script>
</html>